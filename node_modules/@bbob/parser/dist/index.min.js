!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((t=t||self).BbobParser={})}(this,(function(t){"use strict";function n(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function e(t,n){return t(n={exports:{}},n.exports),n.exports}var r=e((function(t,n){n.__esModule=!0,n.BACKSLASH=n.PLACEHOLDER_SPACE=n.PLACEHOLDER_SPACE_TAB=n.SLASH=n.CLOSE_BRAKET=n.OPEN_BRAKET=n.SPACE=n.QUOTEMARK=n.EQ=n.TAB=n.R=n.F=n.N=void 0;n.N="\n";n.TAB="\t";n.F="\f";n.R="\r";n.EQ="=";n.QUOTEMARK='"';n.SPACE=" ";n.OPEN_BRAKET="[";n.CLOSE_BRAKET="]";n.SLASH="/";n.BACKSLASH="\\";n.PLACEHOLDER_SPACE_TAB="    ";n.PLACEHOLDER_SPACE=" "}));n(r);var o=r.BACKSLASH,i=r.SLASH,u=r.CLOSE_BRAKET,a=r.OPEN_BRAKET,s=r.SPACE,f=r.QUOTEMARK,c=r.EQ,l=r.TAB,g=r.N,p=e((function(t,n){n.__esModule=!0,n.isEOL=n.isStringNode=n.isTagNode=n.getUniqAttr=n.getNodeLength=n.appendToNode=n.attrValue=n.attrsToString=void 0;var e=function(t){return"object"==typeof t&&!!t.tag};n.isTagNode=e;var o=function(t){return"string"==typeof t};n.isStringNode=o;n.isEOL=function(t){return t===r.N};n.getNodeLength=function t(n){return e(n)?n.content.reduce((function(n,e){return n+t(e)}),0):o(n)?n.length:0};n.appendToNode=function(t,n){t.content.push(n)};var i=function(t){return t.replace(/"/g,"&quot;")},u=function(t,n){var e=typeof n,r={boolean:function(){return n?""+t:""},number:function(){return t+'="'+n+'"'},string:function(){return t+'="'+i(n)+'"'},object:function(){return t+'="'+i(JSON.stringify(n))+'"'}};return r[e]?r[e]():""};n.attrValue=u;n.attrsToString=function(t){return void 0===t?"":Object.keys(t).reduce((function(n,e){return[].concat(n,[u(e,t[e])])}),[""]).join(" ")};n.getUniqAttr=function(t){return Object.keys(t).reduce((function(n,e){return t[e]===e?t[e]:null}),null)}}));n(p);var d=e((function(t,n){function e(t,n){for(var e=0;n.length>e;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function o(){return(o=Object.assign||function(t){for(var n=1;arguments.length>n;n++){var e=arguments[n];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t}).apply(this,arguments)}n.__esModule=!0,n.default=n.TagNode=void 0;var i=function(){function t(t,n,e){this.tag=t,this.attrs=n,this.content=[].concat(e)}var n,i,u,a=t.prototype;return a.attr=function(t,n){return void 0!==n&&(this.attrs[t]=n),this.attrs[t]},a.append=function(t){return(0,p.appendToNode)(this,t)},a.toTagNode=function(){return new t(this.tag.toLowerCase(),this.attrs,this.content)},a.toString=function(){var t=r.OPEN_BRAKET,n=r.CLOSE_BRAKET,e=0===this.content.length,i=this.content.reduce((function(t,n){return t+""+n}),""),u=function(t,n){var e=(0,p.getUniqAttr)(n);if(e){var r=(0,p.attrValue)(t,e),i=o({},n);return delete i[e],""+r+(0,p.attrsToString)(i)}return""+t+(0,p.attrsToString)(n)}(this.tag,this.attrs);return e?""+t+u+n:""+t+u+n+i+t+r.SLASH+this.tag+n},n=t,(i=[{key:"length",get:function(){return(0,p.getNodeLength)(this)}}])&&e(n.prototype,i),u&&e(n,u),t}();n.TagNode=i,i.create=function(t,n,e){return void 0===n&&(n={}),void 0===e&&(e=[]),new i(t,n,e)},i.isOf=function(t,n){return t.tag===n},n.default=i})),h=n(d),A=d.TagNode,v=e((function(t,n){n.__esModule=!0,n.BACKSLASH=n.PLACEHOLDER_SPACE=n.PLACEHOLDER_SPACE_TAB=n.SLASH=n.CLOSE_BRAKET=n.OPEN_BRAKET=n.SPACE=n.QUOTEMARK=n.EQ=n.TAB=n.R=n.F=n.N=void 0;n.N="\n";n.TAB="\t";n.F="\f";n.R="\r";n.EQ="=";n.QUOTEMARK='"';n.SPACE=" ";n.OPEN_BRAKET="[";n.CLOSE_BRAKET="]";n.SLASH="/";n.BACKSLASH="\\";n.PLACEHOLDER_SPACE_TAB="    ";n.PLACEHOLDER_SPACE=" "}));n(v);var T=e((function(t,n){n.__esModule=!0,n.isEOL=n.isStringNode=n.isTagNode=n.getUniqAttr=n.getNodeLength=n.appendToNode=n.attrValue=n.attrsToString=void 0;var e=function(t){return"object"==typeof t&&!!t.tag};n.isTagNode=e;var r=function(t){return"string"==typeof t};n.isStringNode=r;n.isEOL=function(t){return t===v.N};n.getNodeLength=function t(n){return e(n)?n.content.reduce((function(n,e){return n+t(e)}),0):r(n)?n.length:0};n.appendToNode=function(t,n){t.content.push(n)};var o=function(t){return t.replace(/"/g,"&quot;")},i=function(t,n){var e=typeof n,r={boolean:function(){return n?""+t:""},number:function(){return t+'="'+n+'"'},string:function(){return t+'="'+o(n)+'"'},object:function(){return t+'="'+o(JSON.stringify(n))+'"'}};return r[e]?r[e]():""};n.attrValue=i;n.attrsToString=function(t){return void 0===t?"":Object.keys(t).reduce((function(n,e){return[].concat(n,[i(e,t[e])])}),[""]).join(" ")};n.getUniqAttr=function(t){return Object.keys(t).reduce((function(n,e){return t[e]===e?t[e]:null}),null)}}));n(T);var E=T.isTagNode,S=function(t){return t&&void 0!==t.value?t.value:""},L=function(t){return S(t).charCodeAt(0)===i.charCodeAt(0)},N=function(){function t(t,n,e,r){this.type=t+"",this.value=n+"",this.line=Number(e),this.row=Number(r)}var n=t.prototype;return n.isEmpty=function(){return!!this.type},n.isText=function(){return!(!(t=this)||void 0===t.type||"space"!==t.type&&"new-line"!==t.type&&"word"!==t.type);var t},n.isTag=function(){return!(!(t=this)||void 0===t.type)&&"tag"===t.type;var t},n.isAttrName=function(){return!(!(t=this)||void 0===t.type)&&"attr-name"===t.type;var t},n.isAttrValue=function(){return!(!(t=this)||void 0===t.type)&&"attr-value"===t.type;var t},n.isStart=function(){return!L(this)},n.isEnd=function(){return L(this)},n.getName=function(){return n=S(t=this),L(t)?n.slice(1):n;var t,n},n.getValue=function(){return S(this)},n.getLine=function(){return(t=this)&&t.line||0;var t},n.getColumn=function(){return(t=this)&&t.row||0;var t},n.toString=function(){return t=a,t+=S(this),t+=u;var t},t}(),y=function(t,n){var e={pos:0,length:t.length},r=function(){e.pos+=1,n&&n.onSkip&&n.onSkip()},o=function(){return e.length>e.pos},i=function(){return t.substr(e.pos)},u=function(){return t[e.pos]};return{skip:r,hasNext:o,isLast:function(){return e.pos===e.length},grabWhile:function(n){var i=0;if(o())for(i=e.pos;o()&&n(u());)r();return t.substr(i,e.pos-i)},getNext:function(){var n=e.pos+1;return n>t.length-1?null:t[n]},getPrev:function(){var n=e.pos-1;return void 0!==t[n]?t[n]:null},getCurr:u,getRest:i,substrUntilChar:function(t){var n=i(),e=n.indexOf(t);return 0>e?"":n.substr(0,e)}}},O=function(t){void 0===t&&(t=[]);var n=t;return{getLast:function(){return Array.isArray(n)&&n.length>0&&void 0!==n[n.length-1]?n[n.length-1]:null},flushLast:function(){return!!n.length&&n.pop()},push:function(t){return n.push(t)},toArray:function(){return n}}},b=function(t,n,e,r){return void 0===e&&(e=0),void 0===r&&(r=0),new N(t,n,e,r)};function C(t,n){void 0===n&&(n={});var e=0,r=0,p=-1,d=Array(Math.floor(t.length)),h=n.openTag||a,A=n.closeTag||u,v=n.enableEscapeTags,T=[A,h,f,o,s,l,c,g,"!"],E=[h,s,l,g],S=[s,l],L=[c,s,l],N=function(t){return S.indexOf(t)>=0},O=function(t){return-1===E.indexOf(t)},C=function(t){return t===h||t===A||t===o},_=function(t){return t===o},P=function(t){n.onToken&&n.onToken(t),d[p+=1]=t},R=function(t){for(var n=null,i=!1,u=[],a=y(t),s=function(t){var e=t===c,r=N(t),u=a.getPrev(),s=a.getNext(),l=u===o;return null===n?!1===(e||r||a.isLast()):!(!i||!function(t){return L.indexOf(t)>=0}(t))||!!(t!==f||l||(i=!i)||s===c||N(s))&&!1===(e||r)},l=function(){var t=a.grabWhile(s),i=a.getCurr();if(null===n)n=t;else if(N(i)||i===f||!a.hasNext()){var c=function(t){return t.replace(o+f,f)}(function(t,n){for(;t.charAt(0)===n;)t=t.substring(1);for(;t.charAt(t.length-1)===n;)t=t.substring(0,t.length-1);return t}(t,f));u.push(b("attr-value",c,e,r))}else u.push(b("attr-name",t,e,r));a.skip()};a.hasNext();)l();return{tag:n,attrs:u}},k=y(t,{onSkip:function(){r++}}),B=function(){var t=k.getCurr(),n=k.getNext();if(t===g)k.skip(),e++,P(b("new-line",t,e,r=0));else if(N(t)){var o=k.grabWhile(N);P(b("space",o,e,r))}else if(v&&_(t)&&C(n))k.skip(),k.skip(),P(b("word",n,e,r));else if(t===h){k.skip();var u=k.substrUntilChar(A),a=0===u.length||u.indexOf(h)>=0;if(T.indexOf(n)>=0||a||k.isLast())P(b("word",t,e,r));else{var s=k.grabWhile((function(t){return t!==A}));if(k.skip(),-1===s.indexOf(c)||s[0]===i)P(b("tag",s,e,r));else{var f=R(s);P(b("tag",f.tag,e,r)),f.attrs.map(P)}}}else if(t===A)k.skip(),P(b("word",t,e,r));else if(O(t))if(v&&_(t)&&!C(n))k.skip(),P(b("word",t,e,r));else{var l=k.grabWhile((function(t){return v?O(t)&&!_(t):O(t)}));P(b("word",l,e,r))}};return{tokenize:function(){for(;k.hasNext();)B();return d.length=p+1,d},isTokenNested:function(n){var e=h+i+n.getValue();return t.indexOf(e)>-1}}}var _=function(t,n){void 0===n&&(n={});var e=n,r=null,o=O(),i=O(),u=O(),a=O(),s={},f=function(){u.flushLast()&&a.flushLast()},c=function(t){var n,r,u=(n=i.getLast())&&Array.isArray(n.content)?n.content:o.toArray();Array.isArray(u)&&(E(t)?(r=t.tag,e.onlyAllowTags&&e.onlyAllowTags.length&&0>e.onlyAllowTags.indexOf(r)?u.push(""+t):u.push(t.toTagNode())):u.push(t))},l=function(t){f();var n=h.create(t.getValue()),e=function(t){return void 0===s[t.getValue()]&&(s[t.getValue()]=r.isTokenNested(t)),s[t.getValue()]}(t);u.push(n),e?i.push(n):c(n)},g=function(t){t.isStart()&&l(t),t.isEnd()&&function(t){f();var n=i.flushLast();if(n)c(n);else if("function"==typeof e.onError){var r=t.getValue(),o=t.getLine(),u=t.getColumn();e.onError({message:"Inconsistent tag '"+r+"' on line "+o+" and column "+u,tagName:r,lineNumber:o,columnNumber:u})}}(t)},p=function(t){var n=u.getLast(),e=t.getValue(),r=!!s[t];if(n)if(t.isAttrName())a.push(e),n.attr(a.getLast(),"");else if(t.isAttrValue()){var o=a.getLast();o?(n.attr(o,e),a.flushLast()):n.attr(e,e)}else t.isText()?r?n.append(e):c(e):t.isTag()&&c(""+t);else t.isText()?c(e):t.isTag()&&c(""+t)};(r=(n.createTokenizer?n.createTokenizer:C)(t,{onToken:function(t){t.isTag()?g(t):p(t)},onlyAllowTags:e.onlyAllowTags,openTag:e.openTag,closeTag:e.closeTag,enableEscapeTags:e.enableEscapeTags})).tokenize();return o.toArray()};t.TagNode=A,t.default=_,t.parse=_,Object.defineProperty(t,"__esModule",{value:!0})}));
